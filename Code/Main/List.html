<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Admin - Pengajuan</title>
  <link rel="stylesheet" href="/Main/dashboard_admin.css">
  <link rel="stylesheet" href="/css/refresh.css">
  <link rel="stylesheet" href="/css/footer.css">  
  <link rel="stylesheet" href="/css/link.css">
  <link rel="stylesheet" href="/css/buttonhover.css">
  <style>
    body { font-family: Arial, sans-serif; }
    .sort-btn { cursor: pointer; margin-left: 5px; }
    button { padding: 6px 12px; border-radius: 5px; cursor: pointer; }
    #exportBtn { background-color: #3498db; color: white; border: none; margin-bottom: 10px; }
    #exportBtn:hover { background-color: #2980b9; }
    .header-with-img { display: flex; align-items: center; gap: 10px; }
    .header-logo { width: 90px; height: auto; }
    .page-btn { padding: 4px 8px; }
    
  </style>
</head>
<body>

<header>
  <div class="container" style="display: flex; align-items: center; justify-content: space-between;">
    <h1 class="header-with-img">
      <img src="../favicon.png" alt="Logo" class="header-logo">
      <a href="/Main/dashboard_admin.html">Manajemen Gudang - Admin</a>
    </h1>
    <nav style="display: flex; gap: 15px; align-items: center;">
      <a href="dashboard_admin.html">Dashboard</a>
      <a href="barangmasuk.html">Barang Masuk</a>
      <a href="/Main/List.html">Pengajuan</a>
      <a href="/Dropdown/dropdown.html">Dropdown</a>
      <button onclick="logout()" style="font-weight: bold; padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
        Logout
      </button>
    </nav>
  </div>
</header>

<main>
  <div class="dashboard-container">
    <h2>Database Pengajuan</h2>

  <!-- üîπ Status & Pagination -->
<div id="status">‚è≥ Memuat data...</div>
<div id="pagination" style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
  <button class="page-btn" id="prevPageBtn">‚¨ÖÔ∏è Sebelumnya</button>
  <span id="pageInfo"></span>
  <button class="page-btn" id="nextPageBtn">Berikutnya ‚û°Ô∏è</button>
</div>


    <!-- Tombol Export -->
    <div style="margin-bottom:10px;">
      <button id="exportBtn" style="margin-top: 20px;">Export ke Excel</button>
      <button id="goToSheetBtn" style="display:none; margin-left:10px; margin-top:10px;">Buka Google Sheet</button>
      <button id="openFilter" class="filter-btn">Filter</button>
    </div>

    <!-- Popup Modal Filter -->
    <div id="filterModal" class="modal">
      <div class="modal-content">
        <span id="closeFilter" class="close">&times;</span>
        <div class="filter-container">
          <h3>Filter Data Pengajuan</h3>
          <label for="searchInput">Nama Peminjam / Barang:</label>
          <input type="text" id="searchInput" placeholder="Ketik nama peminjam atau barang...">
          <label for="searchTanggal">Tanggal Pengajuan:</label>
          <input type="date" id="searchTanggal">
        </div>
      </div>
    </div>
   <!-- üîπ Tabel Peminjaman -->
<div class="table-container">
  <table id="peminjamanTable">
    <thead>
      <tr>
        <th>No</th>
        <th>Kode Pengajuan <button class="sort-btn">‚áÖ</button></th>
        <th>Nama Peminjam <button class="sort-btn">‚áÖ</button></th>
        <th>Email <button class="sort-btn">‚áÖ</button></th>
        <th>Kelas / Jabatan <button class="sort-btn">‚áÖ</button></th>
        <th>Nama Barang <button class="sort-btn">‚áÖ</button></th>
        <th>Jumlah Barang <button class="sort-btn">‚áÖ</button></th>
         <th>Tanggal Peminjaman <button class="sort-btn">‚áÖ</button></th>
         <th>Tipe Pengajuan <button class="sort-btn">‚áÖ</button></th>
        <th>Keperluan <button class="sort-btn">‚áÖ</button></th>
        <th>Foto Pengambilan (Wajah & Barang) <button class="sort-btn">‚áÖ</button></th>
        <th>Foto Pengembalian (Wajah & Barang) <button class="sort-btn">‚áÖ</button></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
  </div>
</main>

<footer>
  <p>¬© 2025 IT Support Dharma Loka. All rights reserved.</p>
</footer>

<!-- ExcelJS UMD -->
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

<script type="module">


const exportBtn = document.getElementById("exportBtn");
exportBtn.addEventListener("click", async () => {
  try {
    const table = document.getElementById("peminjamanTable");
    const rows = Array.from(table.querySelectorAll("tbody tr"));

    if (rows.length === 0) {
      alert("Tidak ada data untuk diexport!");
      return;
    }

    const workbook = new ExcelJS.Workbook();
    const sheet = workbook.addWorksheet("Peminjaman");

    // Header
    const headerRow = table.querySelectorAll("thead th");
    const excelHeader = Array.from(headerRow).map(th => th.textContent);
    const rowHeader = sheet.addRow(excelHeader);

    // Styling header
    rowHeader.eachCell((cell) => {
      cell.font = { bold: true, color: { argb: "FFFFFFFF" } };
      cell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FF3498DB' } // biru
      };
      cell.alignment = { vertical: 'middle', horizontal: 'center' };
      cell.border = {
        top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'}
      };
    });

    // Isi data
    rows.forEach((tr) => {
      const tds = tr.querySelectorAll("td");

      // Ambil semua foto
      const fotoTd = tds[7];
      const fotoBtns = Array.from(fotoTd.querySelectorAll(".foto-btn"));
      const fotoUrls = fotoBtns.map(btn => btn.getAttribute("onclick").match(/'(.*?)'/)[1]);

      if (fotoUrls.length === 0) {
        // Tidak ada foto, row biasa
        const rowData = Array.from(tds).map(td => td.textContent);
        sheet.addRow(rowData);
      } else {
        // Baris pertama: semua data + foto pertama
        const firstRow = [
          tds[0].textContent,
          tds[1].textContent,
          tds[2].textContent,
          tds[3].textContent,
          tds[4].textContent,
          tds[5].textContent,
          tds[6].textContent,
          fotoUrls[0]
        ];
        sheet.addRow(firstRow);

        // Baris berikutnya: kolom data kosong, hanya kolom foto
        for (let i = 1; i < fotoUrls.length; i++) {
          const emptyRow = ["", "", "", "", "", "", "", fotoUrls[i]];
          sheet.addRow(emptyRow);
        }
      }
    });

    // Set column width
    sheet.columns.forEach(col => { col.width = 25; });

    // Download file
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `Peminjaman_${new Date().toISOString().slice(0,10)}.xlsx`;
    a.click();
    URL.revokeObjectURL(url);

  } catch (err) {
    console.error("Error export Excel:", err);
    alert("Gagal export ke Excel!");
  }
});


</script>

 <script type="module" src="/js/firebase.js"></script>
  <script type="module" src="/js/drive.js"></script>
  <script type="module" src="/js/app.js"></script>
  <script type="module" src="/js/proteksi.js"></script>
  <script type="module" src="/Main/MainSystemList.js"></script>
  <script type="module" src="/Main/List.js"></script>
  <script type="module">
   
  import { initSortButtons } from '/js/sortbtn.js';
  initSortButtons("peminjamanTable"); // id tabel
</script>

</body>
</html>
