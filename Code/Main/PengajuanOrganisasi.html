<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Admin - Pengajuan</title>
  <link rel="stylesheet" href="/Main/dashboard_admin.css">
  <link rel="stylesheet" href="/css/refresh.css">
  <link rel="stylesheet" href="/css/footer.css">  
  <link rel="stylesheet" href="/css/link.css">
  <link rel="stylesheet" href="/css/buttonhover.css">
  <style>
    body { font-family: Arial, sans-serif; }
    .sort-btn { cursor: pointer; margin-left: 5px; }
    button { padding: 6px 12px; border-radius: 5px; cursor: pointer; }
    #exportBtn { background-color: #3498db; color: white; border: none; margin-bottom: 10px; }
    #exportBtn:hover { background-color: #2980b9; }
    .header-with-img { display: flex; align-items: center; gap: 10px; }
    .header-logo { width: 90px; height: auto; }
    .page-btn { padding: 4px 8px; }
    .editor-panel {
  display: none; /* default hidden */
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  justify-content:center;
  align-items:center;
  z-index:1000;
  transition: opacity 0.3s ease;
}/* Overlay */
#editorPanel {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  justify-content: center;
  align-items: center; /* center vertikal */
  padding: 40px 10px;  /* jarak atas/bawah dan samping */
  z-index: 1001;
}

/* Konten modal fleksibel */
#editorPanel .editor-content {
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  padding: 25px 30px;
  border-radius: 15px;
  width: 100%;
  max-width: 500px;   /* maksimal lebar */
  box-shadow: 0 15px 35px rgba(0,0,0,0.25);
  transform: translateY(-20px);
  opacity: 0;
  transition: all 0.35s ease;
  position: relative;
}

/* Modal aktif */
#editorPanel.active .editor-content {
  transform: translateY(0);
  opacity: 1;
}

/* Tombol tutup */
.editor-close {
  position: absolute;
  top: 10px; right: 10px;
  background: #e74c3c;
  color: #fff;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
}
.editor-close:hover {
  background: #c0392b;
}

/* Tombol simpan */
.editor-save {
  background: #2ecc71;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
}
.editor-save:hover {
  background: #27ae60;
}

/* Label & input */
.editor-body label {
  font-weight: 600;
  margin-bottom: 5px;
  display: block;
}
.editor-body select,
.editor-body textarea {
  width: 100%;
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  outline: none;
}
.editor-body select:focus,
.editor-body textarea:focus {
  border-color: #3498db;
}
.editor-body textarea {
  min-height: 80px;
  resize: vertical;
}

/* Spacing */
.editor-row {
  margin-bottom: 15px;
}

/* Header tabel khusus */
#peminjamanTable th.status-header,
#peminjamanTable th.cek-header,
#peminjamanTable th.kategori-header,
#peminjamanTable th.pic-header,
#peminjamanTable th.catatan-header {
  background: linear-gradient(135deg, #28a745, #218838); /* hijau gradient */
  color: white;
  text-align: center;
  padding: 10px;
  border-radius: 5px 5px 0 0;
}

/* Optional: hover efek pada header */
#peminjamanTable th.status-header:hover,
#peminjamanTable th.cek-header:hover,
#peminjamanTable th.kategori-header:hover,
#peminjamanTable th.pic-header:hover,
#peminjamanTable th.catatan-header:hover {
  background: linear-gradient(135deg, #218838, #28a745);
  cursor: default;
}

  </style>
</head>
<body>

<header>
  <div class="container" style="display: flex; align-items: center; justify-content: space-between;">
    <h1 class="header-with-img">
      <img src="../favicon.png" alt="Logo" class="header-logo">
      <a href="/Main/dashboard_admin.html">Manajemen Gudang - Admin</a>
    </h1>
    <nav style="display: flex; gap: 15px; align-items: center;">
      <a href="dashboard_admin.html">Dashboard</a>
      <a href="barangmasuk.html">Barang Masuk</a>
      <a href="/Main/List.html">Pengajuan</a>
      <a href="/Dropdown/dropdown.html">Dropdown</a>
      <button onclick="logout()" style="font-weight: bold; padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
        Logout
      </button>
    </nav>
  </div>
</header>

<main>
  <div class="dashboard-container">
    <h2>Database Pengajuan</h2>

  <!-- üîπ Status & Pagination -->
<div id="status">‚è≥ Memuat data...</div>
<div id="pagination" style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
  <button class="page-btn" id="prevPageBtn">‚¨ÖÔ∏è Sebelumnya</button>
  <span id="pageInfo"></span>
  <button class="page-btn" id="nextPageBtn">Berikutnya ‚û°Ô∏è</button>
</div>


    <!-- Tombol Export -->
    <div style="margin-bottom:10px;">
      <button id="exportBtn" style="margin-top: 20px;">Export ke Excel</button>
      <button id="goToSheetBtn" style="display:none; margin-left:10px; margin-top:10px;">Buka Google Sheet</button>
      <button id="openFilter" class="filter-btn">Filter</button>
    </div>

    <!-- Popup Modal Filter -->
    <div id="filterModal" class="modal">
      <div class="modal-content">
        <span id="closeFilter" class="close">&times;</span>
        <div class="filter-container">
          <h3>Filter Data Pengajuan</h3>
          <label for="searchInput">Nama Peminjam / Barang:</label>
          <input type="text" id="searchInput" placeholder="Cari berdasarkan Kode, Email, dan Nama Organisasi...">
          <label for="searchTanggal">Tanggal Pengajuan:</label>
          <input type="date" id="searchTanggal">
        </div>
      </div>
    </div>
   <div class="table-container">
  <table id="peminjamanTable">
  <thead>
    <tr>
      <th>No</th>
      <th>Kode Pengajuan</th>
      <th>Email</th>
      <th>Nama Organisasi</th>
      <th>Nama Barang</th>
      <th>Jumlah Barang</th>
      <th>Harga Satuan</th>
      <th>Total Harga</th>
      <th>Catatan Divisi</th>
      <th>Total Keseluruhan barang yang dipinjam</th>
      <th>Waktu Pengajuan</th>
      <th class="status-header">Status</th>
<th class="cek-header">Cek Sapras</th>
<th class="kategori-header">Kategori</th>
<th class="pic-header">PIC</th>
<th class="catatan-header">Catatan Manajemen & Sapras</th>

      
    </tr>
  </thead>
  <tbody>
    <!-- Data akan diisi oleh JS -->
  </tbody>
</table>

    <tbody>
      <!-- Baris data akan diisi secara dinamis dari Firebase -->
    </tbody>
  </table>
</div>

  </div>
</main>
<section id="editorPanel">
  <div class="editor-content">
    <button id="closeEditorBtn" class="editor-close">‚úñ Tutup</button>
    <h3>Admin Panel</h3>

    <div class="editor-body">

      <!-- Status Editor -->
      <div class="editor-row">
        <label for="statusEditor">Status:</label>
        <div style="display:flex; gap:5px; align-items:center;">
          <select id="statusEditor" style="flex:1;">
            
          </select>
          <button class="add-option-btn" data-target="statusEditor" title="Tambah opsi baru">+</button>
        </div>
      </div>

      <!-- Catatan Manajemen & Sapras -->
      <div class="editor-row">
        <label for="catatanEditor">Catatan Manajemen & Sapras:</label>
        <textarea id="catatanEditor" rows="4" placeholder="Masukkan catatan..."></textarea>
      </div>

      <!-- Cek Sapras -->
      <div class="editor-row">
        <label for="cekSapras">Pengecekan Sapras:</label>
        <div style="display:flex; gap:5px; align-items:center;">
          <select id="cekSapras" style="flex:1;">
            
          </select>
          <button class="add-option-btn" data-target="cekSapras" title="Tambah opsi baru">+</button>
        </div>
      </div>

      <!-- Kategori Editor -->
      <div class="editor-row">
        <label for="kategoriEditor">Kategori:</label>
        <div style="display:flex; gap:5px; align-items:center;">
          <select id="kategoriEditor" style="flex:1;">
            
          </select>
          <button class="add-option-btn" data-target="kategoriEditor" title="Tambah opsi baru">+</button>
        </div>
      </div>

      <!-- PIC Editor -->
      <div class="editor-row">
        <label for="picEditor">PIC:</label>
        <div style="display:flex; gap:5px; align-items:center;">
          <select id="picEditor" style="flex:1;">
            
          </select>
          <button class="add-option-btn" data-target="picEditor" title="Tambah opsi baru">+</button>
        </div>
      </div>

      <!-- Tombol Simpan -->
      <div class="editor-row">
        <button id="saveEditorBtn" class="editor-save">Simpan</button>
      </div>

    </div>
  </div>
</section>
<!-- Popup Input Opsi -->
<div id="addOptionPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
    background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:2000;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px; text-align:center;">
    <h4>Tambah Dropdown Baru</h4>
    <input type="text" id="newOptionInput" placeholder="Masukkan nama Dropdown" style="width:100%; padding:8px; margin:10px 0;"/>
    <div style="display:flex; justify-content:space-between; gap:10px;">
      <button id="cancelOptionBtn" style="flex:1; padding:8px; border:none; background:#e74c3c; color:#fff; border-radius:5px;">Batal</button>
      <button id="saveOptionBtn" style="flex:1; padding:8px; border:none; background:#2ecc71; color:#fff; border-radius:5px;">Simpan</button>
    </div>
  </div>
</div>
<div id="toastNotification" style="
    position: fixed;
    top: 20px;       /* dari bawah jadi dari atas */
    right: 20px;     /* tetap kanan */
    min-width: 200px;
    background-color: #333;
    color: #fff;
    padding: 12px 20px;
    border-radius: 8px;
    display: none;
    z-index: 9999;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-family: sans-serif;
    font-size: 14px;
"></div>


<footer>
  <p>¬© 2025 IT Support Dharma Loka. All rights reserved.</p>
</footer>
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script type="module">
const exportBtn = document.getElementById("exportBtn");

exportBtn.addEventListener("click", async () => {
  try {
    const table = document.getElementById("peminjamanTable");
    const rows = Array.from(table.querySelectorAll("tbody tr"));

    if (rows.length === 0) {
      alert("Tidak ada data untuk diexport!");
      return;
    }

    const workbook = new ExcelJS.Workbook();
    const sheet = workbook.addWorksheet("Data Pengajuan");

    // Header Excel
    const header = ["No", "Kode Pengajuan", "Email", "Nomor Organisasi", "Nama Barang", "Jumlah Barang", "Harga Satuan", "Total Harga", "Catatan Divisi", "Total Keseluruhan", "Tanggal Pembuatan"];
    const headerRow = sheet.addRow(header);

    // Styling header
    headerRow.eachCell((cell) => {
      cell.font = { bold: true, color: { argb: "FFFFFFFF" } };
      cell.fill = { type: 'pattern', pattern:'solid', fgColor:{ argb:'FF3498DB' } };
      cell.alignment = { vertical:'middle', horizontal:'center' };
      cell.border = {
        top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'}
      };
    });

    // Isi data
    let index = 1;
    rows.forEach(tr => {
      const tds = tr.querySelectorAll("td");
      const kodePengajuan = tds[1].textContent;
      const email = tds[2].textContent;
      const nomorOrg = tds[3].textContent;
      const namaBarang = tds[4].textContent;
      const jumlahBarang = tds[5].textContent;
      const hargaSatuan = tds[6].textContent;
      const totalHarga = tds[7].textContent;
      const catatanDivisi = tds[8].textContent;
      const totalKeseluruhan = tds[9].textContent;
      const createdAt = tds[10].textContent;

      sheet.addRow([
        index,
        kodePengajuan,
        email,
        nomorOrg,
        namaBarang,
        jumlahBarang,
        hargaSatuan,
        totalHarga,
        catatanDivisi,
        totalKeseluruhan,
        createdAt
      ]);
      index++;
    });

    // Set lebar kolom
    sheet.columns.forEach(col => col.width = 20);

    // Download file
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `DataPengajuan_${new Date().toISOString().slice(0,10)}.xlsx`;
    a.click();
    URL.revokeObjectURL(url);

  } catch (err) {
    console.error("Gagal export Excel:", err);
    alert("Gagal export ke Excel!");
  }
});

// inisialisasi tombol sorting
import { initSortButtons } from '/js/sortbtn.js';
initSortButtons("peminjamanTable"); 

// ====== Popup & Tambah Opsi ======
let targetSelect = null;

// Tombol + di dropdown
document.querySelectorAll('.add-option-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    targetSelect = document.getElementById(btn.dataset.target);
    document.getElementById('newOptionInput').value = "";
    document.getElementById('addOptionPopup').style.display = "flex"; // tampilkan popup
  });
});

// Tombol Batal di popup
document.getElementById('cancelOptionBtn').addEventListener('click', () => {
  document.getElementById('addOptionPopup').style.display = "none";
});
// ====== Fungsi notifikasi ======
function showToast(message, type = "info") {
  const toast = document.getElementById("toastNotification");
  toast.textContent = message;

  if(type === "success") toast.style.backgroundColor = "#2ecc71";
  else if(type === "error") toast.style.backgroundColor = "#e74c3c";
  else toast.style.backgroundColor = "#333";

  toast.style.display = "block";

  setTimeout(() => {
    toast.style.display = "none";
  }, 3000);
}

// Tombol Simpan di popup
document.getElementById('saveOptionBtn').addEventListener('click', async () => {
  const newOption = document.getElementById('newOptionInput').value.trim();
  if (newOption === "") {
    showToast("Isi nama opsi terlebih dahulu!", "error");
    return;
  }
  if (!targetSelect) return;

  // Cek duplikat di dropdown UI
  const existsInDropdown = Array.from(targetSelect.options).some(opt => opt.value.toLowerCase() === newOption.toLowerCase());
  if (existsInDropdown) {
    showToast(`Opsi "${newOption}" sudah ada di dropdown!`, "error");
    return;
  }

  // Cek duplikat di Firestore
  try {
    const q = query(collection(db, targetSelect.id), where("name", "==", newOption));
    const snapshot = await getDocs(q);
    if (!snapshot.empty) {
      showToast(`Opsi "${newOption}" sudah ada di database!`, "error");
      return;
    }

    // Tambahkan ke dropdown UI
    const optionEl = document.createElement('option');
    optionEl.value = newOption;
    optionEl.textContent = newOption;
    targetSelect.appendChild(optionEl);

    // Tambahkan ke Firestore
    await addDoc(collection(db, targetSelect.id), { name: newOption, createdAt: new Date() });

    showToast(`Opsi "${newOption}" berhasil ditambahkan!`, "success");

    // Tutup popup
    document.getElementById('addOptionPopup').style.display = "none";
  } catch (err) {
    console.error("Gagal menambahkan opsi:", err);
    showToast("Terjadi kesalahan saat menyimpan ke database!", "error");
  }
});


import { db } from "./firebase.js";
import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

// Daftar ID dropdown yang mau di-load dari Firebase
const dropdownIds = ["statusEditor", "cekSapras", "kategoriEditor", "picEditor"];

async function loadDropdownOptions() {
  for (const id of dropdownIds) {
    const selectEl = document.getElementById(id);
    if (!selectEl) continue;

    try {
      const querySnapshot = await getDocs(collection(db, id));
      // Kosongkan dulu dropdown (kecuali opsi default)
      selectEl.querySelectorAll("option:not([value=''])").forEach(opt => opt.remove());

      querySnapshot.forEach(doc => {
        const data = doc.data();
        if (data.name) {
          const optionEl = document.createElement("option");
          optionEl.value = data.name;
          optionEl.textContent = data.name;
          selectEl.appendChild(optionEl);
        }
      });
      console.log(`Dropdown ${id} berhasil di-load dari Firebase`);
    } catch (err) {
      console.error(`Gagal load dropdown ${id}:`, err);
    }
  }
}

// Jalankan saat halaman siap
window.addEventListener("DOMContentLoaded", () => {
  loadDropdownOptions();
});

</script>


 <script type="module" src="/js/firebase.js"></script>
  <script type="module" src="/js/drive.js"></script>
  <script type="module" src="/js/app.js"></script>
  <script type="module" src="/js/proteksi.js"></script>
  <script type="module" src="/Main/MainSystemList.js"></script>
  <script type="module" src="/Main/FilterPengajuanOrganisasi.js"></script>
  
  <script type="module" src="/Main/DataPengajuanOrganisasi.JS"></script>

</body>
</html>
